<script>
  const CM_TO_PT = 28.3464567;
  const cm = v => v * CM_TO_PT;

  /* ---------- tiny helpers ---------- */
  function autosizeFirstName(font, text, maxWidth, max, min) {
    let size = max;
    while (size >= min &&
           font.widthOfTextAtSize(text, size) > maxWidth) size--;
    return Math.max(size, min);
  }

  /* ---------- main handler ---------- */
  const form       = document.getElementById('generatorForm');
  const statusTxt  = document.createElement('span');         // NEW
  statusTxt.id     = 'status';
  statusTxt.className = 'text-sm text-gray-500';
  form.appendChild(statusTxt);                               // NEW

  form.addEventListener('submit', async ev => {
    ev.preventDefault();

    const btn = document.getElementById('generateBtn');
    btn.disabled = true;                                     // NEW
    statusTxt.textContent = 'Generating… please wait';       // NEW

    try {
      /* read fields -------------------------------------------------------- */
      const get = id => document.getElementById(id).value.trim();
      const group   = get('groupName');
      const pdfName = (get('pdfName').replace(/\\.pdf$/i,'') || 'name_cards') + '.pdf';

      const pageW = +get('pageW'), pageH = +get('pageH');
      const cardW = +get('cardW'), cardH = +get('cardH');
      const fMax  = +get('fontMax'), fMin = +get('fontMin'), fSmall = +get('fontSmall');

      /* roster ------------------------------------------------------------- */
      const file = document.getElementById('csvInput').files[0];
      if (!file) { alert('Choose a CSV first'); btn.disabled = false; return; }

      const rows = await new Promise(res => {
        Papa.parse(file, { skipEmptyLines:true, complete: r => res(r.data) });
      });
      const names = rows.map(r => ({ first:r[1].trim(), last:r[0].trim() }));

      /* build PDF ---------------------------------------------------------- */
      const { PDFDocument, StandardFonts, rgb } = PDFLib;
      const pdf        = await PDFDocument.create();
      const fontR      = await pdf.embedFont(StandardFonts.Helvetica);
      const fontB      = await pdf.embedFont(StandardFonts.HelveticaBold);

      const pageWidth  = cm(pageW),    pageHeight = cm(pageH);
      const cardWidth  = cm(cardW),    cardHeight = cm(cardH);
      const cols = 2, rowsPer = 2, perPage = cols * rowsPer;

      names.forEach((n, i) => {
        if (i % perPage === 0) pdf.addPage([pageWidth, pageHeight]);
        const p   = pdf.getPage(pdf.getPageCount() - 1);
        const pos = i % perPage, col = pos % cols, row = Math.floor(pos / cols);
        const ox  = col * cardWidth, oy = pageHeight - (row + 1) * cardHeight;

        /* outline */
        p.drawRectangle({ x:ox, y:oy, width:cardWidth, height:cardHeight,
                          borderWidth:1.5, borderColor:rgb(0,0,0),
                          borderDashArray:[4,3], color:rgb(1,1,1), opacity:0 });

        /* corner label */
        p.drawText(group, { x:ox+cm(0.5), y:oy+cardHeight-cm(0.5)-10,
                            size:10, font:fontR });

        /* first name */
        const maxW   = cm(cardW - 2);
        const fSize  = autosizeFirstName(fontB, n.first, maxW, fMax, fMin);
        p.drawText(n.first, {
          x: ox + cardWidth/2 - fontB.widthOfTextAtSize(n.first, fSize)/2,
          y: oy + cardHeight/1.7 - fSize/2,
          size: fSize, font: fontB
        });

        /* full name */
        const full = n.first + ' ' + n.last;
        p.drawText(full, {
          x: ox + cardWidth/2 - fontR.widthOfTextAtSize(full, fSmall)/2,
          y: oy + cardHeight/4 - fSmall/2,
          size: fSmall, font: fontR
        });
      });

      /* download ----------------------------------------------------------- */
      const blob = new Blob([await pdf.save()], { type:'application/pdf' });
      const url  = URL.createObjectURL(blob);

      const link = document.getElementById('downloadLink');
      link.href        = url;
      link.download    = pdfName;
      link.textContent = 'Download ' + pdfName;
      link.classList.remove('hidden');

      link.click();                                          // NEW – auto-trigger
      statusTxt.textContent = 'PDF ready!';                  // NEW
    }
    catch (err) {
      console.error(err);
      alert('Error while creating PDF – check the console for details.');
      statusTxt.textContent = '';
    }
    finally {
      btn.disabled = false;                                  // NEW
    }
  });
</script>
